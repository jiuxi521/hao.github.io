---
title: 2024-10-22
createTime: 2024/10/24 20:01:16
permalink: /article/n3zkbacs/
---
# MySQL底层使用B+树，不使用B树
1. 数据库查询每页（16KB）容纳的数据更多，磁盘IO次数少，性能高
	1. B+树非叶子节点保存索引范围，叶子节点报错行数据；
	2. B树所有节点都保存行数据；
2. 叶子节点使用链表连接，适合范围查询
3. B+树的层次稳定，是一颗自平衡树；
	1. ![image.png|500](https://raw.gitmirror.com/jiuxi521/typora/master/202410221610837.png)

	2. ![image.png|500](https://raw.gitmirror.com/jiuxi521/typora/master/202410221609261.png)



# 高并发场景，安全修改一行数据
1. 乐观锁
	1. 添加版本号 or 时间戳 校验；
		1. 数据更新之前先查询，更新数据时拼接pubts或version作为条件
		```java
		-- 读取时获取版本号 
		SELECT value, version FROM table WHERE id = 1; 
		-- 更新时检查版本号是否一致 
		UPDATE table SET value = 'new_value', version = version + 1 WHERE id = 1 AND version = 10; -- 假设旧版本号是10
		```
2. 悲观锁
	2. 对修改行加锁
		1. 排它锁：select * from table where 1=1 for update;
		2. 共享锁：select * from table where 1=1 lock in share mode;
3. 分布式锁
	1. Redis的lua脚本保证多key加锁同时成功，使用redis的setnx命令
	2. 使用zookeeper的临时节点，控制数据的互斥访问 #todo 
4. 修改数据库的隔离级别
	1. 修改隔离级别为串型化读，有性能问题
	2. 修改隔离级别为可重复读，搭配行锁确保一致性
