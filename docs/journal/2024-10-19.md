---
title: 2024-10-19
createTime: 2024/10/24 20:01:16
permalink: /article/3thfafxb/
---
### 缓存双写（同时写Redis和MySQL），如何保证读一致性、缓存写的一致性?
> [数据库和缓存一致性的几种更新策略](https://github.com/Romantic-Lei/Learning-in-practice/blob/master/Redis/12.Redis%E9%AB%98%E9%98%B6%E7%AF%87/3.%E7%BC%93%E5%AD%98%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5%E6%8E%A2%E8%AE%A8/3.%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E5%87%A0%E7%A7%8D%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5.md)
1. 问题
	1. 先·修改MySQL还是先·删除Redis？
	2. 双检加锁策略？
	3. 延时更新（删除）？
	4. 如何保证缓存一致性？如何保证最终一致性？
2. 学习
	1. 允许短时间不同步的业务,可以使用<font color="#ff0000">异步缓写（延时更新）</font>;不允许的业务,采用<font color="#ff0000">同步直写</font>策略
		1. <span style="background:#ff4d4f">以数据库写入的数据为准</span>，设置缓存过期时间，定期清理缓存保证最终一致性
	2. 避免缓存击穿，采用<font color="#ff0000">双检加锁</font>策略（<span style="background:#ff4d4f">多线程读数据</span>）
		1. 并发多请求查询场景，第一个请求查询缓存不存在，添加查询锁；当第一个请求查询数据返回后，回写缓存；后到的请求直接获取缓存返回
		2. ![image.png|500](https://raw.gitmirror.com/jiuxi521/typora/master/202410192026839.png)
	3. 数据更新策略（<span style="background:#ff4d4f">多线程读、写数据库</span>）
		1. 先更新数据库，再更新缓存
			1. 为避免数据库更新成功，缓存更新失败，可引用消息队列（KafKa、RabbitMQ等）保证最终一致性
		2. ~~先更新缓存，再更新数据库~~
			1. 以数据库的数据为基准，不建议
		3. 先删除缓存，再更新数据库
			1. **需保证数据库读写互斥**。否则，出现A线程删缓存后修改数据库，还没修改完成；B线程直接获取到旧数据，并更新缓存
			2. 出现的风险：缓存失效导致大量请求直接访问数据库，造成[[缓存穿透]]
			3. 采用<font color="#ff0000">延时双删</font>：<font color="#00b050">A线程Sleep的时间不好确定</font>
				1. <font color="#ff0000">线程A sleep的时间，就需要大于线程B读取数据再写入缓存的时间。</font>
				2. 使用CompletableFuture开启异步线程执行第二次删除
					1. ![image.png|500](https://raw.gitmirror.com/jiuxi521/typora/master/202410192141814.png)
				3. 使用延迟队列执行第二次删除缓存任务
					1. ![image.png|500](https://raw.gitmirror.com/jiuxi521/typora/master/202410192145782.png)
		4. <font color="#00b050">先更新数据库，再删除缓存</font>
			1. 存在的问题：数据库更新完成后，没有及时更新缓存，B线程读取的是旧数据
				1. 订阅数据库更改的binlog日志，及时删除Redis缓存；删除失败，将删除操作添加至消息队列，直至成功
				2. canal:订阅binlog程序在MySQL中有现成的中间件叫canal，可以完成订阅binlog日志的功能
				3. ![image.png|500](https://raw.gitmirror.com/jiuxi521/typora/master/202410192159434.png)
			2. binlog日志订阅存在短暂的数据不一致，可以保证最终一致性；如果想满足实时一致性，需暂停Redis并发，实时写入
### RSS源
1. 站点之间信息交互的方式；订阅RSS源：订阅信息
2. 阅读软件：[fluent-reader](https://github.com/yang991178/fluent-reader)
3. 订阅源：[RssHub](https://docs.rsshub.app/zh/guide/instances)

### Windows特殊文件夹
|        命令         |             作用             |
| :---------------: | :------------------------: |
|   shell:desktop   |          用户的桌面文件夹          |
|   shell:sendto    |        “发送到"菜单中的文件夹        |
|   shell:startup   | 启动文件夹,用户登录时会自动运行 这个文件夹中的程序 |
|  shell:programs   |       “开始"菜单中的程序文件夹        |
|   shell:appdata   |  应用程序数据文件夹,存储应用程序 的配置文件等   |
|   shell:recent    |         最近使用的文件列表          |
|  shell:favorites  |           收藏夹文件夹           |
|    shell;fonts    |           字体文件夹            |
|  shell:templates  |           模板文件夹            |
|  shell:my music   |          用户的音乐文件夹          |
| shell:my pictures |          用户的图片文件夹          |
|  shell:my videas  |          用户的视频文件夹          |
| shell:start menu  |          用户的开始菜单           |
### Windows的上帝模式
新建文件夹，命名为：**GodMode.{ED7BA470-8E54-465E-825C-99712043E01C}**


