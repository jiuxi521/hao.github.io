---
title: 两阶段提交协议
createTime: 2024/10/24 16:40:02
permalink: /article/p75chjs9/
---
# 两阶段提交协议
## 定义
1. 一种保证分布式事务数据一致性的协议。将分布式事务的提交拆分成了2个阶段，分别是Prepare和Commit/Rollback

## 流程
1. 对Redo Log添加标记【prepare、commit】控制，根据Redo log的标志判断是否已写入Binlog文件【写入Binlog文件的数据不能回滚】
![](https://raw.gitmirror.com/jiuxi521/typora/master/202403241753039.jpeg)

1. Prepare阶段
	1. 将Redo Log写入文件，并刷入磁盘，记录上内部XA事务的ID，同时将Redo Log状态设置为Prepare。
	2. Redo Log写入成功后，再将Binlog同样刷入磁盘，记录XA事务ID。
2. Commit阶段
	1. 向磁盘中的Redo Log写入Commit标识，表示事务提交。
	2. 之后执行器调用存储引擎的接口提交事务

## 案例
1. 假设Redo Log刷入成功了，但是还没来得及刷入Binlog MySQL就挂了。此时重启之后会发现Redo Log并没有Commit标识，此时根据记录的XA事务找到这个事务，进行回滚。
2. 如果Redo Log刷入成功，而且Binlog也刷入成功了，但是还没有来的及将Redo Log从Prepare改成Commit MySQL就挂了，此时重启会发现虽然Redo Log没有Commit标识，但是通过XID查询到的Binlog却已经成功刷入磁盘了。
	1. 此时，虽然Redo Log没有Commit标识，MySQL也要提交这个事务。因为Binlog一旦写入，就可能会被从库或者任何消费Binlog的消费者给消费。如果此时MySQL不提交事务，则可能造成数据不一致。而且目前Redo Log和Binlog从数据层面上，其实已经Ready了，只是差个标志位。