---
title: 两阶段锁协议
createTime: 2024/10/24 16:40:02
permalink: /article/yyhb4wic/
---
# 两阶段锁协议

## 定义
1. 在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议

## 功能
1. 保证事务的一致性和隔离性

## 流程
1. 分为锁定、释放两个阶段；
2. 事务在锁定阶段，可以获取并持有锁，但不能释放任何锁，直到事务结束
3. 事务在释放阶段，一次性释放持有的所有锁。此时，确保事务已完成所有操作

## 提示
1. 如果你的事务中需要锁多个行，要<font color="#ff0000">把最可能造成锁冲突、最可能影响并发度的锁尽量往后放</font>。

## 案例
1. 假设你负责实现一个电影票在线交易业务，顾客 A 要在影院 B 购买电影票。
2. 我们简化一点，这个业务需要涉及到以下操作：
	1. 从顾客 A 账户余额中扣除电影票价；
	2. 给影院 B 的账户余额增加这张电影票价；
	3. 记录一条交易日志。
3. 也就是说，要完成这个交易，我们需要 update 两条记录，并 insert 一条记录。当然，为了保证交易的原子性，我们要把这三个操作放在一个事务中。那么，你会怎样安排这三个语句在事务中的顺序呢？
	1. 当然，为了保证交易的原子性，我们要把这三个操作放在一个事务中。那么，你会怎样安排这三个语句在事务中的顺序呢？
	2. 根据两阶段锁协议，不论你怎样安排语句顺序，所有的操作需要的行锁都是在事务提交的时候才释放的。所以，如果你把语句 2 安排在最后，比如按照 3、1、2 这样的顺序，那么影院账户余额这一行的锁时间就最少。这就最大程度地减少了事务之间的锁等待，提升了并发度。