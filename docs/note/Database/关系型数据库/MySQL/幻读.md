---
title: 幻读
createTime: 2024/10/24 16:40:01
permalink: /article/ethbsww0/
---
# 幻读
## 定义
1. 指在同一个事务中，同样的查询语句在不同的时间点执行时，返回的结果集不一致的情况。（<font color="#ff0000">读到了原来不存在的数据</font>）

## 解决
1. 当前读 + [[Next-Key锁]]：在索引范围内的索引记录和索引间隙同时加锁，防止幻读；<span style="background:#b1ffff">用于修改场景</span>
	1. 当一个事务在某个索引范围内执行查询语句时，InnoDB会为该范围内的索引记录和索引范围之间的间隙设置Next-Key Lock。这样就可以防止其他事务在该范围内插入新的数据行，从而确保了查询结果的一致性。
2. 快照读 + [[MVCC]]：保证读取的快照一定是事务开始时的快照数据，防止幻读；<span style="background:#b1ffff">用于查询场景</span>

## 幻读和脏读的区别
1. [[幻读]]与[[脏读]]的区别：幻读不是因为其他事务对数据行的修改导致的，而是因为在同一个事务中，数据行的可见性发生了变化。

## 同一事务中的快照读+当前读存在幻读

   ```sql
   -- 建表
   CREATE TABLE `accounts` (`id` int NOT NULL AUTO_INCREMENT, `username` varchar(50) DEFAULT NULL, `balance` decimal(10, 2) DEFAULT NULL, PRIMARY KEY (`id`));
   -- 插入数据
	INSERT INTO `test`.`accounts` (`id`, `username`, `balance`) VALUES (1, 'user1', 500.00);
	INSERT INTO `test`.`accounts` (`id`, `username`, `balance`) VALUES (2, 'user2', 500.00);
	INSERT INTO `test`.`accounts` (`id`, `username`, `balance`) VALUES (4, 'user4', 500.00);

	-- A事务：开始事务
	begin;
	-- A事务：范围查询（快照读）
	SELECT * FROM accounts WHERE id >0 && id < 5;
	-- B事务：开始事务
	begin;
	-- B事务：插入数据
	insert into accounts(id,username,balance) values(3,'user3',600);
	-- A事务：加锁进行范围查询
	SELECT * FROM accounts WHERE id >0 && id < 5 for update;  -- 被锁定，需要B事务提交
	-- B事务：提交
	commit；
	-- A事务：加锁进行范围查询返回id=3的数据
	```
